"undefined"==typeof Videos&&(Videos={}),Videos.Explorer=Garnish.Base.extend({$container:null,$explorer:null,$gateways:null,$main:null,$mainContent:null,$modal:null,$playBtns:null,$scroller:null,$search:null,$sectionLinks:null,$spinner:null,$toolbar:null,$videoElements:null,$videos:null,gateways:null,playerModal:null,searchTimeout:null,init:function(e,s){this.settings=s,this.$container=e;const t={namespaceInputId:this.settings.namespaceInputId};Craft.postActionRequest("videos/explorer/get-modal",t,$.proxy(function(e,s){var t,i;"success"==s?e.success?(this.$modal=$(e.html).appendTo(this.$container),this.$main=$(".main",this.$modal),this.$spinner=$(".spinner",this.$modal),this.$gateways=$(".gateways select",this.$modal),this.$sectionLinks=$("nav a",this.$modal),this.$toolbar=$(".toolbar",this.$modal),this.$search=$(".search",this.$modal),this.$mainContent=$(".main .content",this.$modal),this.$videos=$(".videos",this.$modal),this.$scroller=this.$main,this.$explorer=$(".videos-explorer",this.$container),this.gateways=this.$explorer.data("gateways"),this.addListener(this.$gateways,"change","handleGatewayChange"),this.addListener(this.$sectionLinks,"click","handleSectionClick"),this.addListener(this.$search,"textchange","handleSearchChange"),this.addListener(this.$search,"blur","handleSearchBlur"),this.addListener(this.$search,"keypress","handleSearchKeypress"),Craft.initUiElements(),this.selectGateway(this.$gateways.val()),$("nav div:not(.hidden) a:first",this.$modal).trigger("click")):(t="Couldn’t load explorer manager.",e.error&&(t=e.error),i=$('<div class="error">'+t+"</div>"),i.appendTo(this.$container)):(t="Couldn’t load explorer manager.",i=$('<div class="error">'+t+"</div>"),i.appendTo(this.$container))},this))},handleSearchChange:function(e){this.searchTimeout&&clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout($.proxy(this,"search",e),500)},handleSearchBlur:function(e){0==$(e.currentTarget).val().length&&this.$sectionLinks.filter(".sel").trigger("click")},handleSearchKeypress:function(e){e.keyCode==Garnish.RETURN_KEY&&(e.preventDefault(),this.search(e))},handleGatewayChange:function(e){this.selectGateway(e.currentTarget.value)},selectGateway:function(e){$.each(this.gateways,$.proxy(function(s,t){t.handle==e&&(t.supportsSearch?(this.$search.removeClass("disabled"),this.$search.attr("disabled",!1)):(this.$search.val(""),this.$search.addClass("disabled"),this.$search.attr("disabled",!0)))},this))},handleSectionClick:function(e){this.$sectionLinks.filter(".sel").removeClass("sel"),$(e.currentTarget).addClass("sel");const s=$(e.currentTarget).data("gateway"),t=$(e.currentTarget).data("method");var i=$(e.currentTarget).data("options");i||(i={}),this.getVideos(s,t,i),e.preventDefault()},search:function(e){const s=$(e.currentTarget).val();if(s.length>0){const t=this.$gateways.val(),i={q:s};this.getVideos(t,"search",i)}else this.$videos.html("")},playVideo:function(e){const s=$(e.currentTarget).data("gateway"),t=$(e.currentTarget).data("id");this.playerModal?this.playerModal.show():this.playerModal=new Videos.Player({gateway:s,videoId:t,onHide:$.proxy(function(){this.settings.onPlayerHide()},this)}),this.settings.onPlayerShow(),this.playerModal.play({gateway:s,videoId:t})},selectVideo:function(e){this.$videoElements.removeClass("sel"),$(e.currentTarget).addClass("sel");const s=$(e.currentTarget).data("url");this.settings.onSelectVideo(s)},dblClickVideo:function(e){this.selectVideo(e);const s=$(e.currentTarget).data("url");this.settings.onDoubleClickVideo(s)},getVideos:function(e,s,t){this.removeListener(this.$scroller,"scroll");const i={gateway:e,method:s,options:t};this.$spinner.removeClass("invisible"),Craft.postActionRequest("videos/explorer/get-videos",i,$.proxy(function(i,o){if(this.deselectVideos(),this.$spinner.addClass("invisible"),this.$videos.html(""),"success"==o){if(i.error)this.$mainContent.html('<p class="error">'+i.error+"</p>");else if($(".error",this.$mainContent).remove(),this.$videos=$('<div class="videos" />'),this.$videos.html(i.html),this.$mainContent.append(this.$videos),this.$playBtns=$(".play",this.$videos),this.$videoElements=$(".video",this.$videos),this.addListener(this.$playBtns,"click","playVideo"),this.addListener(this.$videoElements,"click","selectVideo"),this.addListener(this.$videoElements,"dblclick","dblClickVideo"),i.more){const a=$('<a class="more btn">More</a>');this.$videos.append(a);var n={};t&&(n=t),n.moreToken=i.moreToken,this.addListener(a,"click",$.proxy(function(){this.loadMore(e,s,n)},this)),this.addListener(this.$scroller,"scroll",$.proxy(function(){this.maybeLoadMore(e,s,n)},this))}}else this.$mainContent.html('<p class="error">Couldn’t load videos.</p>');$(".main",this.$modal).animate({scrollTop:0},0)},this))},maybeLoadMore:function(e,s,t){this.canLoadMore()&&this.loadMore(e,s,t)},canLoadMore:function(){return this.$scroller.prop("scrollHeight")-this.$scroller.scrollTop()<=this.$scroller.outerHeight()+15},loadMore:function(e,s,t){this.removeListener(this.$scroller,"scroll"),$(".more",this.$videos).remove(),this.$spinner.removeClass("invisible");const i=$('<div class="spinner" />');this.$videos.append(i);const o={gateway:e,method:s,options:t};Craft.postActionRequest("videos/explorer/get-videos",o,$.proxy(function(o,a){if(this.deselectVideos(),this.$spinner.addClass("invisible"),i.remove(),"success"==a)if(void 0===o.error){if(this.$videos.append(o.html),this.$playBtns=$(".play",this.$videos),this.$videoElements=$(".video",this.$videos),this.addListener(this.$playBtns,"click","playVideo"),this.addListener(this.$videoElements,"click","selectVideo"),o.more){const n=$('<a class="more btn">More</a>');this.$videos.append(n);var r;r=void 0===t?{}:t,r.moreToken=o.moreToken,this.addListener(n,"click",$.proxy(function(){this.loadMore(e,s,t)},this)),this.addListener(this.$scroller,"scroll",$.proxy(function(){this.maybeLoadMore(e,s,r)},this))}}else this.$videos.html('<p class="error">'+o.error+"</p>")},this))},deselectVideos:function(){if(this.$videoElements){this.$videoElements.filter(".sel").removeClass(".sel"),this.settings.onDeselectVideo()}}});