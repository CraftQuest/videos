{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set centered = true %}

{% includeJsResource "videos/js/refreshToken.js" %}

{% includeCssResource "videos/css/mcp.css" %}


{% if providerClass is not defined %}{% set providerClass = null %}{% endif %}

{% if service is not defined %}
    {% if providerClass %}
        {% set service = craft.videos.getServiceByProviderClass(providerClass) %}
        {% set provider = craft.videos.getServiceProvider(providerClass) %}

        {% if not service %}{% exit 404 %}{% endif %}
    {% else %}
        {% set service = null %}
    {% endif %}
{% endif %}



{% set title = "Configure "~providerClass|t %}

{% set crumbs = [
    { label: "Videos"|t, url: url('videos') },
    { label: "Settings"|t, url: url('videos/settings') },
] %}

{% set content %}

	<form method="post" action="" accept-charset="UTF-8">
		<input type="hidden" name="action" value="videos/settings/saveService" />
		<input type="hidden" name="redirect" value="videos/settings/{{providerClass}}" />
		<input type="hidden" name="service" value="{{providerClass}}" />

        <p>
            <strong>Endpoint : </strong>
            {{actionUrl('videos/settings/serviceCallback', {providerClass:providerClass})}}
        </p>

        {{ forms.textField({
            label: 'Client Id'|t,
            required: true,
            name: 'service[clientId]',
            value: service ? service.clientId : null,
            errors: service ? service.errors('clientId') : null,
            disabled: ((service.token is defined and service.token|length) > 0 ? true : false)
        }) }}

        {{ forms.textField({
            label: 'Client Secret'|t,
            required: true,
            name: 'service[clientSecret]',
            value: service ? service.clientSecret : null,
            errors: service ? service.errors('clientSecret') : null,
            disabled: (service.token is defined and service.token|length > 0 ? true : false)
        }) }}

        {% if service.params is not null %}
            {% for extraParamKey, extraParam in service.params.defineAttributes %}
                {{ forms.textField({
                    label: extraParamKey|t,
                    required: extraParam.required,
                    name: 'service[params]['~extraParamKey~']',
                    value: (attribute(service.params, extraParamKey) is defined ? attribute(service.params, extraParamKey) : null),
                    disabled: (service.token is defined and service.token|length > 0 ? true : false)
                }) }}
            {% endfor %}
        {% endif %}

        {#% for extraParamKey, extraParam in provider.getExtraParameters() %}
            {{ forms.textField({
                label: extraParam.label|t,
                required: extraParam.required,
                name: 'service[params]['~extraParamKey~']',
                value: (service.params[extraParamKey] is defined ? service.params[extraParamKey]: null),
                disabled: (service.token is defined and service.token|length > 0 ? true : false)
            }) }}
        {% endfor %#}

		{% if (service.token is defined and service.token|length == 0) or service.token is not defined %}
			<input class="btn submit" type="submit" name="connect" value="{{ 'Connect to '~providerClass|t }}">  &nbsp;
		{% else %}

			{% if craft.videos.cpSupportsRefresh(providerClass) %}
				<p>Token expires in <strong class="dv-expires" data-providerclass="{{providerClass}}">{{craft.videos.cpTokenExpires(providerClass)}}</strong> seconds. It will be automatically refreshed.</p>

				<a class="btn" href="{{actionUrl('videos/settings/refreshServiceToken', {providerClass:providerClass})}}">Refresh Token</a>
			{% endif %}

            <a class="btn" href="{{actionUrl('videos/settings/resetService', {providerClass:providerClass})}}">Reset Token</a>

		{% endif %}
	</form>

{% endset %}